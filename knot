#!/usr/bin/env ruby
require 'nokogiri'
require 'open-uri'
require 'matrix'

BG = '#012169'
LINE = '#C8102E'
STROKE = 'white'
HORIZ = 4
VERT = 3
ROWS = VERT * 2 + 1
COLS = HORIZ * 2 + 1
GRIDSIZE = 100
W = GRIDSIZE * COLS
H = GRIDSIZE * ROWS
INNER_WIDTH = 20
STROKE_WIDTH = 10

class Point < Vector

  def x
    self[0]
  end

  def y
    self[1]
  end

  def self.midpoint(a, b)
    (a + b) / 2
  end

  def self.distance(a, b)
    (a - b).magnitude
  end
end

class Path
  def initialize
    @path = []
  end

  def M(m)
    @path.push __method__, m.x, m.y
  end

  def m(m)
    @path.push __method__, m.x, m.y
  end

  def L(m)
    @path.push __method__, m.x, m.y
  end

  def l(m)
    @path.push __method__, m.x, m.y
  end

  def A(rx, ry, x_axis_rotation, large_arc, sweep, m)
    @path.push __method__, rx, ry, x_axis_rotation, large_arc, sweep, m.x, m.y
  end

  def z
    @path.push 'z'
    @path.join(' ')
  end
end

class KnotCell
  attr_reader :c, :i, :o

  def initialize(c, inner, stroke)
    outer = inner + stroke

    @c = c

    pos = {
      n: [0, -1], ne: [0.5, -0.5], e: [1, 0], se: [0.5, 0.5],
      s: [0, 1], sw: [-0.5, 0.5], w: [-1, 0], nw: [-0.5, -0.5]
    }

    @i = pos.each_with_object({}) do |(k, v), a|
      a[k] = Point[c.x + v[0] * inner,
                   c.y + v[1] * inner]
    end

    @o = pos.each_with_object({}) do |(k, v), a|
      a[k] = Point[c.x + v[0] * outer,
                   c.y + v[1] * outer]
    end

    subpos = [
      [:n, :sw], [:n, :se],
      [:e, :sw], [:e, :nw],
      [:s, :nw], [:s, :ne],
      [:w, :ne], [:w, :se],
    ]
    subpos.each do |v|
      sym = (v[0].to_s << '_' << v[1].to_s).to_sym
      @o[sym] = Point[@o[v[0]].x + stroke * pos[v[1]][0],
                      @o[v[0]].y + stroke * pos[v[1]][1]]
    end
  end
end

def create_grid
  Matrix.build(ROWS, COLS) do |i, j|
    c = Point[GRIDSIZE * j + GRIDSIZE / 2,
              GRIDSIZE * i + GRIDSIZE / 2]
    KnotCell.new(c, INNER_WIDTH, STROKE_WIDTH)
  end
end

def draw_grid(doc, svg, grid)
  Nokogiri::XML::Node.new 'g', doc do |g|
    svg.add_child g
    g[:fill] = 'white'

    grid.each do |a|
      Nokogiri::XML::Node.new 'circle', doc do |circle|
        g.add_child circle
        circle[:cx] = a.c.x
        circle[:cy] = a.c.y
        circle[:r] = 1
      end
    end
  end

  Nokogiri::XML::Node.new 'g', doc do |g|
    svg.add_child g
    g[:fill] = 'cyan'

    grid.each do |a|
      a.i.each do |k, v|
        Nokogiri::XML::Node.new 'circle', doc do |circle|
          g.add_child circle
          circle[:cx] = v.x
          circle[:cy] = v.y
          circle[:r] = 1
        end
      end
    end

    grid.each do |a|
      a.o.each do |k, v|
        Nokogiri::XML::Node.new 'circle', doc do |circle|
          g.add_child circle
          circle[:cx] = v.x
          circle[:cy] = v.y
          circle[:r] = 1
        end
      end
    end
  end
end

def draw_knot(grid)
  d = Path.new

  (1..(ROWS-3)).step(2) do |i|
    (2..(COLS-5)).step(2) do |j|
      position = Vector[i, j]
      a = grid[*position]

      sw2 = grid[*position + Vector[2, 2]]
      d.M a.o[:e_sw]
      d.L sw2.o[:n_sw]
      d.L sw2.o[:w_ne]
      d.L a.o[:s_ne]
    end
  end

  (4..(ROWS-2)).step(2) do |i|
    (1..(COLS-4)).step(2) do |j|
      position = Vector[i, j]
      a = grid[*position]

      nw2 = grid[*position + Vector[-2, 2]]
      d.M a.o[:e_nw]
      d.L nw2.o[:s_nw]
      d.L nw2.o[:w_se]
      d.L a.o[:n_se]
    end
  end

  # Bend N
  (4..(COLS-3)).step(2) do |j|
    position = Vector[1, j]
    a = grid[*position]

    nw = grid[*position + Vector[-1, -1]]
    w = grid[*position + Vector[0, -1]]
    w2 = grid[*position + Vector[0, -2]]
    b = grid[*position + Vector[1, -3]]

    d.M a.o[:w_ne]
    d.L mp = Point.midpoint(a.i[:w], nw.i[:s])
    sm_r = Point.distance(mp, w.c)
    d.A sm_r, sm_r, 0, 0, 0, Point.midpoint(w2.i[:e], nw.i[:s])
    d.L b.o[:e_nw]
    d.L b.o[:n_se]
    d.L mp = Point.midpoint(nw.i[:w], w2.i[:n])
    b_r = Point.distance(mp, w.c)
    d.A b_r, b_r, 0, 0, 1, Point.midpoint(a.i[:n], nw.i[:e])
    d.L a.o[:n_sw]
  end

  # Bend SE
  position = Vector[ROWS-2, COLS-3]
  a = grid[*position]
  sw = grid[*position + Vector[2, 2] / 2]
  ne = grid[*position + Vector[-1, 1]]
  e2 = grid[*position + Vector[0, 2]]
  n2 = grid[*position + Vector[-2, 0]]
  d.M a.o[:e_sw]
  d.L Point.midpoint(a.i[:e], sw.i[:n])
  d.A 1, 1, 0, 0, 0, Point.midpoint(ne.i[:s], e2.i[:w])
  d.L n2.o[:s_ne]
  d.L n2.o[:e_sw]
  d.L Point.midpoint(ne.i[:e], e2.i[:n])
  d.A 1, 1, 0, 0, 1, Point.midpoint(a.i[:s], sw.i[:w])
  d.L a.o[:s_ne]

  d.z
end

grid = create_grid
doc = Nokogiri::XML::Document.new

Nokogiri::XML::Node.new 'svg', doc do |svg|
  doc.add_child svg
  svg[:xmlns] = 'http://www.w3.org/2000/svg'
  svg[:viewBox] = "0 0 #{W} #{H}"
  svg[:width] = W
  svg[:height] = H

  # Background.
  Nokogiri::XML::Node.new 'path', doc do |path|
    svg.add_child path
    path[:d] = "M0,0 v#{H} h#{W} v-#{H} z"
    path[:fill] = BG
  end

  Nokogiri::XML::Node.new 'g', doc do |g|
    svg.add_child g
    g[:fill] = LINE

    Nokogiri::XML::Node.new 'path', doc do |path|
      g.add_child path
      path[:d] = draw_knot grid
    end
  end
  draw_grid doc, svg, grid
end

puts doc.to_xml indent:2
