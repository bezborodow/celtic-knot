#!/usr/bin/env ruby
require 'nokogiri'
require 'open-uri'
require 'matrix'

W = 800
H = 600
CX = W / 2
CY = H / 2
BG = '#012169'
LINE = '#C8102E'
STROKE = 'white'
HORIZ = 4
VERT = 3
ROWS = VERT * 2 - 1
COLS = HORIZ * 2 - 1
GRIDSIZE = 100

class KnotCell
  attr_accessor :cx, :cy,
    :iny, :inx, :iex, :iey, :isx, :isy, :iwx, :iwy,
    :ony, :onx, :oex, :oey, :osx, :osy, :owx, :owy
end

def create_grid
  Matrix.build(ROWS, COLS) do |i, j|
    inner = 20
    outer = 25

    e = KnotCell.new
    e.cx = j * GRIDSIZE + GRIDSIZE / 2
    e.cy = i * GRIDSIZE + GRIDSIZE / 2
    e.iny = e.cy - inner
    e.inx = e.cx

    e
  end
end

def draw_grid(doc, svg, grid)
  Nokogiri::XML::Node.new 'g', doc do |g|
    svg.add_child g
    g[:fill] = 'white'

    grid.each do |e|
      Nokogiri::XML::Node.new 'circle', doc do |circle|
        g.add_child circle
        circle[:cx] = e.cx
        circle[:cy] = e.cy
        circle[:r] = 1
      end
    end
  end
end

grid = create_grid
doc = Nokogiri::XML::Document.new

Nokogiri::XML::Node.new 'svg', doc do |svg|
  doc.add_child svg
  svg[:xmlns] = 'http://www.w3.org/2000/svg'
  svg[:viewBox] = "0 0 #{W} #{H}"
  svg[:width] = 1200
  svg[:height] = 900

  # Background.
  Nokogiri::XML::Node.new 'path', doc do |path|
    svg.add_child path
    path[:d] = "M0,0 v#{H} h#{W} v-#{H} z"
    path[:fill] = BG
  end

  draw_grid doc, svg, grid
end

puts doc.to_xml indent:2
